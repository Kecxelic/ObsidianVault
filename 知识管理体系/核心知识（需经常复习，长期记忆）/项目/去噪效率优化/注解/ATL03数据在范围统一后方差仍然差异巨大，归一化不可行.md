# 通俗易懂版：为什么ATL03数据归一化后方差仍然差异巨大

## 结论先行
1、归一化后的方差，等于归一化前的方差除以范围的平方。
2、归一化，就是压缩范围大的维度，或者放大范围小的维度。压缩范围大的维度，就会导致该维度更密集，压缩后方差比会更大。放大范围小的维度，方差的变化也是一样的。
所以数据归一化无法解决空间划分不均的问题。

## 先理解几个基本概念

### 1. 极差计算公式

$$ R_x = \text{最大x值} - \text{最小x值} $$
$$ R_z = \text{最大z值} - \text{最小z值} $$

### 2. 归一化计算公式

$$ x_{\text{新}} = \frac{x - \text{最小x}}{R_x} $$
$$ z_{\text{新}} = \frac{z - \text{最小z}}{R_z} $$

### 3. 什么是方差？

**方差**衡量的是数据的"分散程度"：

- 方差大 = 数据点分散在各处
- 方差小 = 数据点聚集在一起

计算公式：
$$ \text{方差} = \frac{\text{所有点与平均值的距离平方和}}{\text{点的数量}} $$

## 归一化后的方差，等于归一化前的方差除以范围的平方（关键）$$ \sigma_{\text{norm},{x/z}}^2 = \frac{\sigma_{x/z}^2}{R_{x/z}^2} $$

当我们把数据归一化后，方差也会按比例变化：

$$ \text{新方差}_x = \frac{\text{旧方差}_x}{(R_x)^2} $$
$$ \text{新方差}_z = \frac{\text{旧方差}_z}{(R_z)^2} $$

### 详细推导过程（数学证明）

**步骤1：定义原始数据**
设原始数据点为 $x_i$（沿轨距离）和 $z_i$（高度），其中 $i = 1, 2, ..., n$

**步骤2：计算原始均值**
$$ \mu_x = \frac{1}{n} \sum_{i=1}^n x_i $$
$$ \mu_z = \frac{1}{n} \sum_{i=1}^n z_i $$

**步骤3：计算原始方差**
$$ \sigma_x^2 = \frac{1}{n} \sum_{i=1}^n (x_i - \mu_x)^2 $$
$$ \sigma_z^2 = \frac{1}{n} \sum_{i=1}^n (z_i - \mu_z)^2 $$

**步骤4：归一化变换**
$$ x_{\text{norm},i} = \frac{x_i - \min(x)}{R_x} $$
$$ z_{\text{norm},i} = \frac{z_i - \min(z)}{R_z} $$
其中 $R_x = \max(x) - \min(x)$，$R_z = \max(z) - \min(z)$

**步骤5：计算归一化后的均值**
$$ \mu_{\text{norm},x} = \frac{1}{n} \sum_{i=1}^n x_{\text{norm},i} = \frac{1}{n} \sum_{i=1}^n \frac{x_i - \min(x)}{R_x} = \frac{\mu_x - \min(x)}{R_x} （已看过，推导正确）$$ 

同理：
$$ \mu_{\text{norm},z} = \frac{\mu_z - \min(z)}{R_z} $$

**步骤6：计算归一化后的方差（关键推导）**
$$ \sigma_{\text{norm},x}^2 = \frac{1}{n} \sum_{i=1}^n (x_{\text{norm},i} - \mu_{\text{norm},x})^2 $$

代入归一化公式：就是
$$ = \frac{1}{n} \sum_{i=1}^n \left( \frac{x_i - \min(x)}{R_x} - \frac{\mu_x - \min(x)}{R_x} \right)^2 $$

$$ = \frac{1}{n} \sum_{i=1}^n \left( \frac{x_i - \mu_x}{R_x} \right)^2 $$

$$ = \frac{1}{R_x^2} \cdot \frac{1}{n} \sum_{i=1}^n (x_i - \mu_x)^2 $$

$$ = \frac{\sigma_x^2}{R_x^2} $$

同理可得：
$$ \sigma_{\text{norm},z}^2 = \frac{\sigma_z^2}{R_z^2} $$

**结论**：归一化后的方差确实等于原始方差除以范围（极差）的平方！

### 符号化推导：归一化前后方差比的变化

**定义符号：**
- 沿轨距离范围：$R_x$
- 高度范围：$R_z$  
- 沿轨距离方差：$\sigma_x^2$
- 高度方差：$\sigma_z^2$

**步骤1：原始方差比**
$$ \text{原始方差比} = \frac{\sigma_x^2}{\sigma_z^2} $$

**步骤2：归一化后的方差**
根据推导公式：
$$ \sigma_{\text{norm},x}^2 = \frac{\sigma_x^2}{R_x^2} $$
$$ \sigma_{\text{norm},z}^2 = \frac{\sigma_z^2}{R_z^2} $$

**步骤3：归一化后的方差比**
$$ \text{归一化后方差比} = \frac{\sigma_{\text{norm},x}^2}{\sigma_{\text{norm},z}^2} = \frac{\sigma_x^2 / R_x^2}{\sigma_z^2 / R_z^2} = \frac{\sigma_x^2}{\sigma_z^2} \cdot \frac{R_z^2}{R_x^2} $$

**关键发现：**
$$ \text{归一化后方差比} = \text{原始方差比} \times \left( \frac{R_z}{R_x} \right)^2 $$

**数学意义：**
归一化后的方差比等于原始方差比乘以（高度范围/沿轨距离范围）的平方！

**物理意义：**
- 如果 $R_x \gg R_z$（沿轨距离范围远大于高度范围），则 $\left( \frac{R_z}{R_x} \right)^2 \ll 1$

- 归一化后方差比会远小于原始方差比

**这说明：**
归一化不仅改变了数据的尺度，更重要的是改变了方差的比例关系，这就是为什么简单的归一化无法解决KD树划分问题的根本原因。

### 数据压缩下限的数学证明

**定义任意压缩函数：**
- 沿轨距离压缩：$f(x) = k_x x$
- 高度压缩：$f(z) = k_z z$

**压缩后的方差关系：**
$$ \sigma_{\text{comp},x}^2 = k_x^2 \sigma_x^2 $$
$$ \sigma_{\text{comp},z}^2 = k_z^2 \sigma_z^2 $$

**压缩后的方差比：**
$$ \frac{\sigma_{\text{comp},x}^2}{\sigma_{\text{comp},z}^2} = \frac{k_x^2 \sigma_x^2}{k_z^2 \sigma_z^2} = \frac{\sigma_x^2}{\sigma_z^2} \cdot \left( \frac{k_x}{k_z} \right)^2 $$

**压缩约束条件：**
从纯数学角度，压缩比例 $\frac{k_x}{k_z}$ 理论上可以任意选择。但在实际工程应用中，压缩比例的选择受到以下限制：

1. **数值精度限制**：当压缩比例过小（如 $\frac{k_x}{k_z} \ll 1$）时，沿轨距离维度的数值可能变得过小，导致浮点数精度损失

2. **算法稳定性**：极端压缩比例可能导致数值计算中的舍入误差累积，影响算法稳定性

3. **计算性能**：过小的压缩比例可能增加计算复杂度，降低处理效率

**重新评估：**
之前的约束条件 $\frac{k_x}{k_z} = M \cdot \frac{R_z}{R_x}$ 确实存在主观性。实际上，压缩比例的选择应该基于具体的应用需求和计算环境，而不是一个固定的数学约束。



**压缩效果分析：**
从压缩后方差比公式：
$$ \frac{\sigma_{\text{comp},x}^2}{\sigma_{\text{comp},z}^2} = \frac{\sigma_x^2}{\sigma_z^2} \cdot \left( \frac{k_x}{k_z} \right)^2 $$

理论上，通过选择足够小的 $\frac{k_x}{k_z}$ 比例，可以任意减小压缩后的方差比。但在实际应用中，压缩比例的选择受到工程限制：

1. **精度限制**：过小的压缩比例会导致沿轨距离维度的数值精度损失
2. **算法稳定性**：极端压缩可能引入数值计算误差
3. **计算效率**：过小的数值范围可能增加计算复杂度

对于ATL03数据，即使采用合理的压缩比例，由于原始方差比通常为 $10^6$ - $10^8$ 量级，压缩后的方差比仍然可能远大于1，无法完全解决KD树划分问题。

**关键结论：**
虽然理论上压缩比例可以任意选择，但在实际工程应用中，由于数值精度、算法稳定性和计算效率的限制，数据压缩方法无法完全解决ATL03数据的方差差异问题。动态方差选择仍然是处理此类数据的有效方案，因为它能够根据局部数据特征动态优化划分维度。

### 动态方差选择的必要性

**为什么数据压缩无法完全解决问题：**
1. **工程限制**：压缩比例受到数值精度、算法稳定性和计算效率的实际限制
2. **原始方差比过大**：通常为 $10^6$ - $10^8$ 量级，即使压缩后仍可能远大于1
3. **分布特性差异**：沿轨数据均匀分布，高度数据聚集分布
4. **线性变换局限**：无法改变数据的基本分布形态

**动态方差选择的优势：**
- **适应性**：根据局部数据特征动态选择划分维度
- **局部优化**：在每个节点选择方差最大的维度进行划分
- **实时计算**：构建过程中实时计算各维度方差
- **效果最优**：确保每次划分都能最大程度平衡子树

**对比总结：**
- **数据压缩**：实现简单但无法解决根本问题，压缩后方差比仍远大于1
- **动态方差选择**：计算开销稍大但效果最优，是KD树构建的必要方案
